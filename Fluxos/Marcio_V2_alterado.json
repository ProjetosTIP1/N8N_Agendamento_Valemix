{
  "name": "Marcio V2",
  "nodes": [
    {
      "parameters": {},
      "type": "@devlikeapro/n8n-nodes-waha.wahaTrigger",
      "typeVersion": 202502,
      "position": [
        -2700,
        400
      ],
      "id": "ab19821c-c061-4c60-a03d-7aa67b1c9886",
      "name": "WAHA Trigger",
      "webhookId": "64a2de0e-e41b-4597-9610-0d3084570a81"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ESTA √â A CONVERSA: {{ $json.mensagem }}",
        "options": {
          "systemMessage": "=üé≠ Fun√ß√£o de assistente:\nVoc√™ √© um Assistente de An√°lise de Mensagens que avalia cada mensagem do cliente para determinar se ela precisa:\n\nFa√ßa uma reserva ou agendamento de entrega.\nFa√ßa uma reclama√ß√£o.\nSua resposta determinar√° o fluxo em n8n:\n\n‚ÄúVERDADEIRO‚Äù ‚Üí O fluxo continua.\n\"FALSO\" ‚Üí O fluxo termina.\n\nüìú Instru√ß√µes:\nAnalise a mensagem do cliente.\nSe a mensagem mencionar uma reserva ou programa√ß√£o, cronograma de entrega ou reclama√ß√£o, responda apenas com \"VERDADEIRO\".\nCaso a mensagem n√£o mencione reserva ou reclama√ß√£o responda apenas com ‚ÄúFALSO‚Äù.\nSe voc√™ j√° respondeu \"VERDADEIRO‚Äù, continue retornando \"TRUE\" em cada mensagem at√© que o assistente respons√°vel termine seu processo em n8n.\nQuando o assistente respons√°vel terminar, pare de responder \"TRUE\".\n\n‚ö†Ô∏è Regras:\nN√£o responda com outra palavra ou frase, apenas ‚ÄúVERDADEIRO‚Äù ou ‚ÄúFALSO‚Äù.\nN√£o explique nem confirme a resposta.\nN√£o altere ‚ÄúFALSE‚Äù para ‚ÄúTRUE‚Äù se a mensagem inicial n√£o contiver reserva ou reclama√ß√£o.\nüîç Exemplo de comportamento em n8n:\n<exemplo> \nüë§ Cliente: ‚ÄúQuero agendar a entrega do meu material para amanh√£.‚Äù \nü§ñ Assistente: \"TRUE\" (o fluxo em n8n continua ao longo do caminho de reserva/reivindica√ß√£o.)\n\nüë§ Cliente: ‚ÄúSer√° √† tarde‚Äù.\nü§ñ Assistente: \"VERDADEIRO\" (Enquanto o assistente respons√°vel ainda estiver em processo.)\n\nüë§ Cliente: \"Meu nome √© M√°rcio Azevedo.\"\nü§ñ Assistente: \"VERDADEIRO\" (siga o processo.)\n\nüë§ Cliente: \"Pronto, isso seria tudo.\" (O assistente em n8n termina.)\nü§ñ Assistente: (para de responder \"VERDADEIRO\", o fluxo termina.)\n\nüë§ Cliente: \"Ol√°, como vai?\"\nü§ñ Assistente: ‚ÄúFALSO‚Äù (O fluxo em n8n termina aqui.)\n</exemplo>"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -1820,
        400
      ],
      "id": "1c24a395-a1d6-4025-9778-1aeb4fad32fe",
      "name": "AI Agent"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1920,
        580
      ],
      "id": "b7f5b103-8081-43e2-8721-ccf2f1b90b2c",
      "name": "OpenAI Chat Model",
      "credentials": {
        "openAiApi": {
          "id": "P34Q5LzomCLBCF7A",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $json.from }}",
        "sessionTTL": 300,
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.4,
      "position": [
        -1780,
        620
      ],
      "id": "71bde80d-963a-4cbf-922b-92fadf145c86",
      "name": "Redis Chat Memory",
      "credentials": {
        "redis": {
          "id": "R3gMrcjTPNyFGMqg",
          "name": "Redis account 2"
        }
      }
    },
    {
      "parameters": {
        "authentication": "genericCredentialType"
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        -1540,
        620
      ],
      "id": "dd977edf-c9c6-4156-93c1-a3879d4f5ff4",
      "name": "HTTP Request",
      "disabled": true
    },
    {
      "parameters": {
        "conditions": {
          "options": {
            "caseSensitive": true,
            "leftValue": "",
            "typeValidation": "strict",
            "version": 2
          },
          "conditions": [
            {
              "id": "65488564-5597-4a2c-af01-5f0d0cf99ea4",
              "leftValue": "={{ $json.output }}",
              "rightValue": "VERDADEIRO",
              "operator": {
                "type": "string",
                "operation": "equals",
                "name": "filter.operator.equals"
              }
            }
          ],
          "combinator": "or"
        },
        "options": {
          "ignoreCase": false
        }
      },
      "type": "n8n-nodes-base.if",
      "typeVersion": 2.2,
      "position": [
        -1460,
        400
      ],
      "id": "a63c31d3-20fd-466f-8ebd-3a831e9323d6",
      "name": "If"
    },
    {
      "parameters": {
        "options": {}
      },
      "type": "n8n-nodes-base.dateTime",
      "typeVersion": 2,
      "position": [
        -1240,
        280
      ],
      "id": "ebe8c1c6-9925-4616-8db4-cbbf181271e7",
      "name": "Date & Time"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "3989ec24-1261-4f59-982b-72fd06198381",
              "name": "from",
              "value": "={{ $('Captura_Mensagem').item.json.from.substring(2,4) }}9{{ $('Captura_Mensagem').item.json.from.substring(4,12) }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -1080,
        280
      ],
      "id": "a1dde741-09b5-4188-83d9-4184669a864f",
      "name": "Formata_Telefone"
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "2e065f4e-b646-47f4-8f62-4c009c10e2e5",
              "name": "session",
              "value": "={{ $json.session }}",
              "type": "string"
            },
            {
              "id": "a3676208-8493-466e-b2a9-8e885b39f338",
              "name": "from",
              "value": "={{ $json.payload.from }}",
              "type": "string"
            },
            {
              "id": "5f23231d-a6ef-48b3-9054-040167eb8868",
              "name": "mensagem",
              "value": "={{ $json.payload.body }}",
              "type": "string"
            },
            {
              "id": "d7bdbe94-1d95-4eaf-99fb-3ab202ca4706",
              "name": "id_mensagem",
              "value": "={{ $json.payload.id }}",
              "type": "string"
            },
            {
              "id": "a4bcff2c-16a7-4455-bf70-e8dc5ef2ad2a",
              "name": "messageType",
              "value": "={{ \n    $json.payload.hasMedia \n        ? ($json.payload.media.mimetype.startsWith(\"image\") \n            ? \"image\" \n            : ($json.payload.media.mimetype.startsWith(\"audio\") \n                ? \"audio\" \n                : \"other_media\")) \n        : \"text\"\n}}\n",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -2300,
        400
      ],
      "id": "2a9a44dc-c06f-4129-bc0e-561a1a14353a",
      "name": "Captura_Mensagem"
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Seen",
        "chatId": "={{ $json.from }}",
        "messageId": "={{ $json.id_mensagem }}",
        "participant": "",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        -2140,
        220
      ],
      "id": "6152edb5-94d6-4812-a046-24ccbfa89077",
      "name": "Marca_Visualizacao",
      "credentials": {
        "wahaApi": {
          "id": "x51fih2shQhRra4Q",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "return items.map(item => {\n  return {\n    json: {\n        customerName: item.json.data.page_items.map(p => p.customer.name),\n        customerCode: item.json.data.page_items.map(p => p.customer.code),\n        customerId: item.json.data.page_items.map(p => p.customer.id)\n    }\n  }\n});"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        -720,
        280
      ],
      "id": "5e4faa07-9486-477d-97ad-7ad769e8d00c",
      "name": "Code",
      "alwaysOutputData": false
    },
    {
      "parameters": {
        "rules": {
          "values": [
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "leftValue": "={{ $json.debugMessageType }}",
                    "rightValue": "text",
                    "operator": {
                      "type": "string",
                      "operation": "equals"
                    },
                    "id": "7bfab073-e0ca-4d36-9e2a-817378e450a9"
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "texto"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "615af114-9e88-4495-90d8-aceedd03a643",
                    "leftValue": "={{ $json.debugMessageType }}",
                    "rightValue": "image",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "imagem"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "e92e8ff9-cc7d-44a5-8e57-f6cb5fab020d",
                    "leftValue": "={{ $json.debugMessageType }}",
                    "rightValue": "audio",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "audio"
            },
            {
              "conditions": {
                "options": {
                  "caseSensitive": true,
                  "leftValue": "",
                  "typeValidation": "strict",
                  "version": 2
                },
                "conditions": [
                  {
                    "id": "51902449-461a-4875-a52b-024d21dea546",
                    "leftValue": "={{ $json.debugMessageType }}",
                    "rightValue": "other_media",
                    "operator": {
                      "type": "string",
                      "operation": "equals",
                      "name": "filter.operator.equals"
                    }
                  }
                ],
                "combinator": "and"
              },
              "renameOutput": true,
              "outputKey": "outro"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.switch",
      "typeVersion": 3.2,
      "position": [
        -360,
        260
      ],
      "id": "461d82de-6ee8-4cb1-a604-cf8965e00321",
      "name": "Switch",
      "alwaysOutputData": false,
      "executeOnce": false
    },
    {
      "parameters": {
        "assignments": {
          "assignments": [
            {
              "id": "a96e6489-94a1-44c0-a991-dcd6515596e3",
              "name": "debugMessageType",
              "value": "={{ $('Captura_Mensagem').item.json.messageType.replace(/\\n/g, \"\").trim() }}",
              "type": "string"
            }
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.set",
      "typeVersion": 3.4,
      "position": [
        -560,
        280
      ],
      "id": "cb359ec0-6976-4c28-8aba-11352775aa93",
      "name": "TipoMensagem"
    },
    {
      "parameters": {
        "url": "=https://integration.readymix.io/api/sync/projects?contact_phone_number={{ $('Formata_Telefone').item.json.from }}",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -900,
        280
      ],
      "id": "06289ae1-09d3-4fe2-82af-c5db68a9e248",
      "name": "Loop_Project_ContactPhoneNumber",
      "credentials": {
        "httpHeaderAuth": {
          "id": "cxexuqhR4R8NRjo6",
          "name": "Header Auth account"
        }
      }
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=mensagem: {{ $('Captura_Mensagem').item.json.mensagem }};\ndata e hora atuais: {{ $('Date & Time').item.json.currentDate }}\nProjetos associados: {{ $('Code').item.json.customerName }}\nnome do cliente: {{ $('WAHA Trigger').item.json.me.pushName }}\nendere√ßo: {{ $('Loop_Project_ContactPhoneNumber').item.json.data.page_items[0].address.address_full }}\n",
        "options": {
          "systemMessage": "=üé≠ Papel do Assistente\nVoc√™ √© um assistente virtual especializado em log√≠stica do Pedreira Um Valemix, empresa que atua no setor de Concretos Pr√©-Misturados, \ncontando com uma moderna frota de caminh√µes betoneira e bomba-lan√ßa, bem como laborat√≥rios que realizam o controle tecnol√≥gico do concreto. \nEstruturada para produzir o concreto que o cliente desejar, a Valemix disp√µe de uma equipe de assistentes t√©cnico-comerciais que visitam as obras, \ncoletando todas as informa√ß√µes necess√°rias a um perfeito atendimento. \nSua principal fun√ß√£o √© atuar como intermedi√°rio entre os clientes e a equipe de log√≠stica, garantindo que:\n\nCumprimentar de forma adequada ao contexto, mantendo um tom respeitoso e natural.\nVoc√™ imita a maneira de falar e escrever da pessoa que estava atendendo o cliente antes de agir. Se o cliente usar linguagem formal, ela permanece a mesma. \nSe ele usar abreviaturas ou um tom mais descontra√≠do, adapte.\nOriente o cliente atrav√©s do processo apropriado com base em sua solicita√ß√£o.\nMantenha a consist√™ncia na comunica√ß√£o para que a transi√ß√£o entre humano e assistente seja impercept√≠vel.\nA data atual √© {{ $now }}.\n\nüìå Voc√™ deve identificar a planta. \nSegue abaixo a lista das plantas com o seu respectivo c√≥digo [plant_code] e [plant_name]:\n1 - FILIAL Tim√≥teo\n2 - FILIAL Jo√£o Monlevade\n3 - FILIAL Governando Valadares\n5 - FILIAL OURO BRANCO\n8 - FILIAL SANTANA DO PARA√çSO\n\nüîÑ Fluxo 1: Reserva de Concreto\nSe o cliente estiver solicitando uma reserva, siga estas etapas:\n\nüìå Etapa 1: Identifica√ß√£o do Projeto\n1Ô∏è‚É£ Caso o cliente tenha projetos cadastrados ‚Üí Pe√ßa para ele selecionar o projeto.\n2Ô∏è‚É£ Caso n√£o tenha projetos cadastrados solicite que entre em contato com o vendedor.\n\nüìå Etapa 2: Coleta de dados\nSolicite as seguintes informa√ß√µes, mantendo o mesmo tom da conversa:\n\n1Ô∏è‚É£ Data de entrega (data_entrega)\nüóìÔ∏è ‚ÄúAt√© que data voc√™ precisa receber o material?‚Äù (Verifique se √© posterior √† data atual).\nSalve a data no formato americado YYYY-MM-DD e quando for exibir para o usu√°rio na confirma√ß√£o ultilize o formato brasileiro DD-MM-YYYY.\n\n2Ô∏è‚É£ Prazo de entrega (data_hora)\n‚è∞ \"A que horas deseja receber o pedido?\"\n\n3Ô∏è‚É£ Local de entrega (data_local)\nüìç \"Usar o endere√ßo associado ao contrato, n√£o pergunte, somente informe e passe para proxima etapa. \nCaso o cliente deseje alterar o endere√ßo cancele o fluxo e informe que procure o vendedor\"\n\n4Ô∏è‚É£ Quantidade em metros c√∫bicos (data_quantidade)\nüèóÔ∏è \"Quantos metros c√∫bicos voc√™ precisa?\"\n\n5Ô∏è‚É£ Tipo de concreto (data_produto)\nüîé \"Usar o produto associado ao contrato {{ $('Loop_Project_ContactPhoneNumber').item.json.data.page_items[0].project_product[0].product.name }}\n\n6Ô∏è‚É£ Tipo de servi√ßo de descarga (data_servico)\nüöõ \"Como deseja a descarga? Pode ser convencional ou bombe√°vel.\"\n\nüìå Utilize a ferramenta \"Readymix\" para inserir os dados no banco de dados.\n\nüìåConfirme com o cliente:\n\n\"Vou lhe dar um resumo do seu pedido:\n\nüìÜ Entrega: [data_entrega] \nüïí Hora: [data_hora]\nüìç Localiza√ß√£o: [data_local]\nüì¶ Quantidade: [data_quantidade] m¬≥\nüèóÔ∏è Concreto: [data_produto]\nüöõ Servi√ßo de Bomba: [data_servico]\nüè≠ Central: [plant_name]\nüè≠ Codigo da Central: [plant_code]\nüìå ID do pedido: [plan_id]\n\n\n\"Est√° tudo bem ou voc√™ quer modificar alguma coisa?\"\n\nüìå Caso o cliente confirme, registre as informa√ß√µes no Readymix.\n##voc√™ deve fazer pergunta por pergunta, quando voc√™ pedir a primeira para obter os dados voc√™ deve aguardar a resposta do cliente e depois fazer a pr√≥xima pergunta##\nüó£Ô∏è Tom e Estilo nas Reservas:\n‚úÖ Profissional mas adaptado ao cliente.\n‚úÖ Use emojis para deixar a conversa mais clara.\n‚úÖ Sempre confirme antes de gravar dados.\n\n\nü§ñ Adapta√ß√£o de tom e forma de escrever\nüìå Regras para manter a consist√™ncia com a conversa anterior:\n\nSe o orador anterior usou um tom formal, o assistente dever√° continuar com um tom formal.\nSe voc√™ usou abrevia√ß√µes ou linguagem descontra√≠da, o assistente dever√° imitar esse estilo.\nSe o cliente usou emojis ou express√µes informais, o assistente tamb√©m pode us√°-los.\nüìå Exemplo de mudan√ßa de tom:\n\nüë§ Humano: \"Ol√°, bom dia, em que posso te ajudar?\"\nüë§ Cliente: ‚ÄúOl√°, preciso fazer uma reserva.‚Äù\nü§ñ Assistente: \"Claro! Para que data voc√™ quer?\"\n\nüë§ Humano: \"Ei, como vai? O que voc√™ precisa?\"\nüë§ Cliente: ‚ÄúOl√°, preciso fazer uma reserva.‚Äù\nü§ñ Assistente: \"Vamos, me diga em que data vou agendar para voc√™.\"\n\nüìå Integra√ß√£o com n8n\nüìå Caso detecte uma reserva, responda ‚ÄúVERDADEIRO‚Äù e continue a conversa.\nüìå Se em nenhum momento for mencionada reserva, responda ‚ÄúFALSO‚Äù.\nüìå Se voc√™ j√° retornou ‚ÄúTRUE‚Äù, continue retornando ‚ÄúTRUE‚Äù at√© que o processo seja conclu√≠do.\nüìå Quando o assistente respons√°vel no n8n terminar sua parte, pare de responder \"VERDADEIRO\".\n\n\n\n\n"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        460,
        220
      ],
      "id": "ff38a9a0-8674-4479-80ed-b2738f916eca",
      "name": "Assist_IA"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "value": "gpt-4o-mini",
          "mode": "list",
          "cachedResultName": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        280,
        540
      ],
      "id": "b135f455-c62f-4ed8-a3bc-a227a5c44b7d",
      "name": "OpenAI Chat Model1",
      "credentials": {
        "openAiApi": {
          "id": "P34Q5LzomCLBCF7A",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={\n\n}",
        "sessionTTL": 300,
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.4,
      "position": [
        400,
        640
      ],
      "id": "f779e699-9dbd-48a2-aa6d-1314c7483958",
      "name": "Redis Chat Memory1",
      "credentials": {
        "redis": {
          "id": "R3gMrcjTPNyFGMqg",
          "name": "Redis account 2"
        }
      }
    },
    {
      "parameters": {
        "jsCode": "// Loop over input items and add a new field called 'myNewField' to the JSON of each one\nfor (const item of $input.all()) {\n  item.json.myNewField = 1;\n}\n\nreturn $input.all();"
      },
      "type": "n8n-nodes-base.code",
      "typeVersion": 2,
      "position": [
        840,
        220
      ],
      "id": "e3083fbc-affd-4d07-b544-a1dda431c2ef",
      "name": "Code1"
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=Resposta a formatar:  {{ $json.output }}",
        "hasOutputParser": true
      },
      "type": "@n8n/n8n-nodes-langchain.chainLlm",
      "typeVersion": 1.5,
      "position": [
        1100,
        140
      ],
      "id": "3e359f34-618a-4351-9133-6b706e95510f",
      "name": "Basic LLM Chain"
    },
    {
      "parameters": {
        "options": {
          "prompt": "Instructions:\n--------------\n{instructions}\n--------------\nCompletion:\n--------------\n{completion}\n--------------\n\nAbove, the Completion did not satisfy the constraints given in the Instructions.\nError:\n--------------\n{error}\n--------------\n\nPlease try again. Please only respond with an answer that satisfies the constraints laid out in the Instructions:"
        }
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserAutofixing",
      "typeVersion": 1,
      "position": [
        1220,
        360
      ],
      "id": "66cf6347-cb68-49e8-8047-60df7e581615",
      "name": "Auto-fixing Output Parser"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1080,
        380
      ],
      "id": "3873ddcc-863a-4d06-b240-92653eea7b22",
      "name": "OpenAI Chat Model2",
      "credentials": {
        "openAiApi": {
          "id": "P34Q5LzomCLBCF7A",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "jsonSchemaExample": "{\n\t\"resposta\": \n    {\n      \"parte_1\": \"Conte√∫do da primeira parte da resposta.\",\n      \"parte_2\": \"Conte√∫do da segunda parte da resposta.\",\n      \"parte_3\": \"Conte√∫do da terceira parte da resposta. (Opcional)\"\n    }\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.outputParserStructured",
      "typeVersion": 1.2,
      "position": [
        1380,
        520
      ],
      "id": "aae4a43c-9c04-47e7-aa5f-a834f23f05ec",
      "name": "Structured Output Parser"
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {
          "temperature": 0.1
        }
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        1180,
        560
      ],
      "id": "bd1a94f8-a6f9-4a97-9d09-50357622842f",
      "name": "OpenAI Chat Model3",
      "credentials": {
        "openAiApi": {
          "id": "P34Q5LzomCLBCF7A",
          "name": "OpenAi account"
        }
      }
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        1800,
        220
      ],
      "id": "3d13d523-4da9-445e-9b68-e64d6fe0b44a",
      "name": "Wait",
      "webhookId": "599097fb-2b9a-40b1-a4a9-75a7e3c85640"
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Captura_Mensagem').item.json.session }}",
        "chatId": "={{ $('Captura_Mensagem').item.json.from }}",
        "text": "={{ $json.output.resposta.parte_1 }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        1640,
        220
      ],
      "id": "15bdb09c-7739-47fb-ba6a-0593a10b78c7",
      "name": "Resposta_Parte1",
      "credentials": {
        "wahaApi": {
          "id": "x51fih2shQhRra4Q",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Captura_Mensagem').item.json.session }}",
        "chatId": "={{ $('Captura_Mensagem').item.json.from }}",
        "text": "={{ $('Basic LLM Chain').item.json.output.resposta.parte_2 }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        1960,
        220
      ],
      "id": "f217add1-706e-4eea-9b47-2ef8526fb953",
      "name": "Resposta_Parte2",
      "credentials": {
        "wahaApi": {
          "id": "x51fih2shQhRra4Q",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "amount": 2
      },
      "type": "n8n-nodes-base.wait",
      "typeVersion": 1.1,
      "position": [
        2120,
        220
      ],
      "id": "b378a8f1-05d5-4695-a75e-1173e54cce81",
      "name": "Wait1",
      "webhookId": "785ebcd2-5b09-476b-839d-3c1a3ed24e38"
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Captura_Mensagem').item.json.session }}",
        "chatId": "={{ $('Captura_Mensagem').item.json.from }}",
        "text": "={{ $('Basic LLM Chain').item.json.output.resposta.parte_3 }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        2280,
        220
      ],
      "id": "712b57e2-0b51-447f-a1c4-26af0399a55f",
      "name": "Resposta_Parte3",
      "credentials": {
        "wahaApi": {
          "id": "x51fih2shQhRra4Q",
          "name": "WAHA account"
        }
      }
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Captura_Mensagem').item.json.session }}",
        "chatId": "={{ $('Captura_Mensagem').item.json.from }}",
        "text": "=Programar Concreto",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        0,
        0
      ],
      "id": "bee56950-5015-44c8-9199-1a05d550de21",
      "name": "Texto_Teste",
      "disabled": true
    },
    {
      "parameters": {
        "url": "={{ $('WAHA Trigger').item.json.payload._data.message.audioMessage.url }}",
        "sendBody": true,
        "bodyParameters": {
          "parameters": [
            {}
          ]
        },
        "options": {}
      },
      "type": "n8n-nodes-base.httpRequest",
      "typeVersion": 4.2,
      "position": [
        -440,
        500
      ],
      "id": "5544f75a-4595-4fb9-9cb8-17456b164998",
      "name": "Baixar_Audio",
      "disabled": true
    },
    {
      "parameters": {
        "operation": "fromJson",
        "options": {}
      },
      "type": "n8n-nodes-base.extractFromFile",
      "typeVersion": 1,
      "position": [
        -200,
        500
      ],
      "id": "9df24498-5e1d-41b7-a511-6ef57fa02b2c",
      "name": "Extract from File",
      "disabled": true
    },
    {
      "parameters": {
        "resource": "audio",
        "operation": "transcribe",
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.openAi",
      "typeVersion": 1.8,
      "position": [
        0,
        500
      ],
      "id": "90b8d78a-bc28-402d-bcf1-978c6a11e9a8",
      "name": "OpenAI",
      "disabled": true
    },
    {
      "parameters": {
        "tableId": "n8n",
        "fieldsUi": {
          "fieldValues": [
            {
              "fieldId": "nome",
              "fieldValue": "teste"
            }
          ]
        }
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -1680,
        820
      ],
      "id": "e82a520f-0d03-4e66-b4e5-dbd197334633",
      "name": "Supabase",
      "credentials": {
        "supabaseApi": {
          "id": "e5VzI3gIx8zbm5mb",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "operation": "getAll",
        "tableId": "n8n",
        "filterType": "none"
      },
      "type": "n8n-nodes-base.supabase",
      "typeVersion": 1,
      "position": [
        -2000,
        800
      ],
      "id": "3b844621-323a-4bbf-8e30-41f57c442fc9",
      "name": "Supabase1",
      "credentials": {
        "supabaseApi": {
          "id": "e5VzI3gIx8zbm5mb",
          "name": "Supabase account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('WAHA Trigger').item.json.session }}",
        "chatId": "={{ $('WAHA Trigger').item.json.payload.from }}",
        "text": "=ID gerado: v{{ $json.id }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        -1460,
        820
      ],
      "id": "1948fa7e-305b-4d2e-bc9e-87912cbf4841",
      "name": "WAHA",
      "credentials": {
        "wahaApi": {
          "id": "x51fih2shQhRra4Q",
          "name": "WAHA account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://integration.loop4.io/api/sync/plans-reservations",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "={\n  \"date\": \"{fecha_loop}\",\n  \"plant_code\": \"PL-RES\",\n  \"quantity\": \"{quantidade_loop}\",\n  \"notes\": \"{dados_loop}\",\n  \"trip_max_vol\": 8,\n  \"first_arrival_at\": \"{inicio_loop}\",\n  \"truck_interval\": 0,\n  \"back_time\": 0,\n  \"go_time\": 0,\n  \"unload_time\": 0,\n  \"load_time\": 0\n}"
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        740,
        780
      ],
      "id": "f35ea13c-4d08-462e-a8a9-ccffc4841614",
      "name": "Loop",
      "credentials": {
        "httpHeaderAuth": {
          "id": "cxexuqhR4R8NRjo6",
          "name": "Header Auth account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "resource": "Chatting",
        "operation": "Send Text",
        "session": "={{ $('Captura_Mensagem').item.json.session }}",
        "chatId": "={{ $('Captura_Mensagem').item.json.from }}",
        "text": "={{ $json.output }}",
        "requestOptions": {}
      },
      "type": "@devlikeapro/n8n-nodes-waha.WAHA",
      "typeVersion": 202502,
      "position": [
        -740,
        640
      ],
      "id": "5edb5474-c907-4314-b543-4928b86cffd5",
      "name": "Resposta_Parte",
      "credentials": {
        "wahaApi": {
          "id": "x51fih2shQhRra4Q",
          "name": "WAHA account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "promptType": "define",
        "text": "=ESTA √â A CONVERSA: {{ $('Captura_Mensagem').item.json.mensagem }}",
        "options": {
          "systemMessage": "=üé≠ Fun√ß√£o de assistente:\nVoc√™ √© um Assistente de An√°lise de Mensagens que avalia cada mensagem do cliente para determinar se ela precisa:\n\nFa√ßa uma reserva ou agendamento de entrega.\nFa√ßa uma reclama√ß√£o.\n\nEle n√£o escolheu nenhumas das op√ß√µes valida, continue a conversa respondendo a bom dia ou ola dependendo da mensagem e oriente ele de forma educada que precisa escolher uma."
        }
      },
      "type": "@n8n/n8n-nodes-langchain.agent",
      "typeVersion": 1.7,
      "position": [
        -1180,
        480
      ],
      "id": "2b6fa513-b470-4f63-8264-a28fa629c47e",
      "name": "AI Agent1",
      "disabled": true
    },
    {
      "parameters": {
        "model": {
          "__rl": true,
          "mode": "list",
          "value": "gpt-4o-mini"
        },
        "options": {}
      },
      "type": "@n8n/n8n-nodes-langchain.lmChatOpenAi",
      "typeVersion": 1.2,
      "position": [
        -1260,
        700
      ],
      "id": "b5238574-0593-4267-bd1a-4dc062e1cdf7",
      "name": "OpenAI Chat Model4",
      "credentials": {
        "openAiApi": {
          "id": "P34Q5LzomCLBCF7A",
          "name": "OpenAi account"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "sessionIdType": "customKey",
        "sessionKey": "={{ $('Captura_Mensagem').item.json.mensagem }}",
        "sessionTTL": 180,
        "contextWindowLength": 10
      },
      "type": "@n8n/n8n-nodes-langchain.memoryRedisChat",
      "typeVersion": 1.4,
      "position": [
        -1100,
        700
      ],
      "id": "603aa3e1-36bc-4ffe-978c-8eb1d84b79ad",
      "name": "Redis Chat Memory2",
      "credentials": {
        "redis": {
          "id": "R3gMrcjTPNyFGMqg",
          "name": "Redis account 2"
        }
      },
      "disabled": true
    },
    {
      "parameters": {
        "method": "POST",
        "url": "https://integration.loop4.io/api/sync/orders",
        "authentication": "genericCredentialType",
        "genericAuthType": "httpHeaderAuth",
        "sendBody": true,
        "specifyBody": "json",
        "jsonBody": "=[\n    {\n        \"order_code\": \"V00002\",\n        \"delivery_date\": \"2025-05-11 03:40:00\",\n        \"plant_code\": \"{plant_code}\",\n        \"project_code\": \"547312624\",\n        \"project_name\": \"VALEMIX CONCRETOS - BLOCOS\",\n        \"project_pincode\": \"1234\",\n        \"customer_code\": \"149123\",\n        \"customer_name\": \"FILIAL SANTANA DO PARAISO\",\n        \"customer_document\": \"04.702.118/0005-46\",\n        \"customer_email\": null,\n        \"customer_number\": \"38255000\",\n        \"customer_note\": null,\n\t\t\t\t\"address_code\": \"#18\",\n        \"address_street\": \"AV VITO GAGGIATO\",\n        \"address_number\": \"0\",\n        \"address_district\": \"INDUSTRIAL\",\n        \"address_complement\": \"SN\",\n        \"address_full\": null,\n        \"city_code\": null,\n        \"city_name\": \"SANTANA DO PARAISO\",\n        \"purchase_order\": null,\n        \"usage_code\": null,\n        \"usage_name\": null,\n        \"status_code\": \"920\",\n        \"status_name\": \"INATIVO\",\n        \"status_blocked\": false,\n        \"status_color\": \"#FF0000\",\n        \"internal_notes\": \"Some internal Notes you can add here.\",\n        \"customer_notes\": \"Some customer Notes you can add here.\",\n        \"display_price\": true,\n        \"tax_code\": null,\n        \"tax_name\": null,\n        \"tax_value\": 0,\n        \"seller_code\": null,\n        \"seller_name\": null,\n        \"order_products\": [\n\t\t\t\t\t{ \n\t\t\t\t\t\t\t\"item_number\":1,\n\t\t\t\t\t\t\t\"product_code\": {{ $('Loop_Project_ContactPhoneNumber').item.json.data.page_items[0].project_product[0].product.code }},\n\t\t\t\t\t\t\t\"product_type\": 1,\n\t\t\t\t\t\t\t\"product_name\": {{ $('Loop_Project_ContactPhoneNumber').item.json.data.page_items[0].project_product[0].product.name }},\n\t\t\t\t\t\t\t\"product_list_price\": 0,\n\t\t\t\t\t\t\t\"quantity\": \"{data_quantidade}\",\n\t\t\t\t\t\t\t\"price\": {{ $('Loop_Project_ContactPhoneNumber').item.json.data.page_items[0].project_product[0].price }},\n\t\t\t\t\t\t\t\"pump_order_code\": null\n\t\t\t\t\t}\n\t\t\t\t]\n\t\t}\n]"
      },
      "type": "@n8n/n8n-nodes-langchain.toolHttpRequest",
      "typeVersion": 1.1,
      "position": [
        600,
        640
      ],
      "id": "1c85557e-1e76-4590-855f-582c37a67854",
      "name": "Readymix",
      "credentials": {
        "httpHeaderAuth": {
          "id": "cxexuqhR4R8NRjo6",
          "name": "Header Auth account"
        }
      }
    }
  ],
  "pinData": {},
  "connections": {
    "WAHA Trigger": {
      "main": [
        [],
        [
          {
            "node": "Captura_Mensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory": {
      "ai_memory": [
        [
          {
            "node": "AI Agent",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent": {
      "main": [
        [
          {
            "node": "If",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "HTTP Request": {
      "ai_tool": [
        [
          {
            "node": "AI Agent",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    },
    "If": {
      "main": [
        [
          {
            "node": "Date & Time",
            "type": "main",
            "index": 0
          }
        ],
        [
          {
            "node": "AI Agent1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Date & Time": {
      "main": [
        [
          {
            "node": "Formata_Telefone",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Formata_Telefone": {
      "main": [
        [
          {
            "node": "Loop_Project_ContactPhoneNumber",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Captura_Mensagem": {
      "main": [
        [
          {
            "node": "Marca_Visualizacao",
            "type": "main",
            "index": 0
          },
          {
            "node": "AI Agent",
            "type": "main",
            "index": 0
          },
          {
            "node": "Supabase1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code": {
      "main": [
        [
          {
            "node": "TipoMensagem",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Switch": {
      "main": [
        [
          {
            "node": "Texto_Teste",
            "type": "main",
            "index": 0
          }
        ],
        [],
        [
          {
            "node": "Baixar_Audio",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "TipoMensagem": {
      "main": [
        [
          {
            "node": "Switch",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Loop_Project_ContactPhoneNumber": {
      "main": [
        [
          {
            "node": "Code",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model1": {
      "ai_languageModel": [
        [
          {
            "node": "Assist_IA",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory1": {
      "ai_memory": [
        [
          {
            "node": "Assist_IA",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "Assist_IA": {
      "main": [
        [
          {
            "node": "Code1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Code1": {
      "main": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Auto-fixing Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model2": {
      "ai_languageModel": [
        [
          {
            "node": "Basic LLM Chain",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Structured Output Parser": {
      "ai_outputParser": [
        [
          {
            "node": "Auto-fixing Output Parser",
            "type": "ai_outputParser",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI Chat Model3": {
      "ai_languageModel": [
        [
          {
            "node": "Auto-fixing Output Parser",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Basic LLM Chain": {
      "main": [
        [
          {
            "node": "Resposta_Parte1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait": {
      "main": [
        [
          {
            "node": "Resposta_Parte2",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resposta_Parte1": {
      "main": [
        [
          {
            "node": "Wait",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Resposta_Parte2": {
      "main": [
        [
          {
            "node": "Wait1",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Wait1": {
      "main": [
        [
          {
            "node": "Resposta_Parte3",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Texto_Teste": {
      "main": [
        [
          {
            "node": "Assist_IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Baixar_Audio": {
      "main": [
        [
          {
            "node": "Extract from File",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Extract from File": {
      "main": [
        [
          {
            "node": "OpenAI",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "OpenAI": {
      "main": [
        [
          {
            "node": "Assist_IA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase": {
      "main": [
        [
          {
            "node": "WAHA",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Supabase1": {
      "main": [
        [
          {
            "node": "Supabase",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "WAHA": {
      "main": [
        []
      ]
    },
    "Loop": {
      "ai_tool": [
        []
      ]
    },
    "OpenAI Chat Model4": {
      "ai_languageModel": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_languageModel",
            "index": 0
          }
        ]
      ]
    },
    "Redis Chat Memory2": {
      "ai_memory": [
        [
          {
            "node": "AI Agent1",
            "type": "ai_memory",
            "index": 0
          }
        ]
      ]
    },
    "AI Agent1": {
      "main": [
        [
          {
            "node": "Resposta_Parte",
            "type": "main",
            "index": 0
          }
        ]
      ]
    },
    "Readymix": {
      "ai_tool": [
        [
          {
            "node": "Assist_IA",
            "type": "ai_tool",
            "index": 0
          }
        ]
      ]
    }
  },
  "active": false,
  "settings": {
    "executionOrder": "v1"
  },
  "versionId": "4f13d9ce-31ce-46e9-859a-23a0dfd4742f",
  "meta": {
    "instanceId": "badc5188b69000db68bb5a183789c429759caa0da80040090ad2ce1e9b217ea0"
  },
  "id": "NC8Jo46xkpy0EILJ",
  "tags": []
}